/* --- Robustness helpers: debounce / disable UI / export-import --- */

function debounce(fn, wait=300) {
  let t;
  return function(...args){
    clearTimeout(t);
    t = setTimeout(()=> fn.apply(this,args), wait);
  };
}

// disable/enable all interactive buttons to avoid rapid double-click issues
function setUIEnabled(enabled) {
  document.querySelectorAll('button, input').forEach(el=>{
    // keep name input enabled always (so user can type), but disable buttons if requested
    if (el.tagName.toLowerCase() === 'button') el.disabled = !enabled;
  });
}

// wrap original addOrUpdate with protection & debounce
const originalAddOrUpdate = window.addOrUpdate;
window.addOrUpdate = debounce(function(){
  setUIEnabled(false);
  try {
    originalAddOrUpdate();
  } finally {
    // small timeout to avoid instant re-enable while render still settling
    setTimeout(()=>setUIEnabled(true), 120);
  }
}, 250);

// safer changeScore wrapper to protect mass clicks
const originalChangeScore = window.changeScore;
window.changeScore = function(name, delta){
  setUIEnabled(false);
  try {
    originalChangeScore(name, delta);
  } finally {
    setTimeout(()=>setUIEnabled(true), 120);
  }
};

// safer remove / clear with confirmation
const originalRemove = window.remove;
window.remove = function(name){
  if (!confirm(`Delete "${name}"? This cannot be undone.`)) return;
  setUIEnabled(false);
  try { originalRemove(name); } finally { setTimeout(()=>setUIEnabled(true),120); }
};

const originalClearAll = window.clearAll;
window.clearAll = function(){
  if (!confirm("Clear all entries? This will erase local data.")) return;
  setUIEnabled(false);
  try { originalClearAll(); } finally { setTimeout(()=>setUIEnabled(true),120); }
};

// EXPORT / IMPORT functions (adds two small controls to the top)
function exportData() {
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'rizz-data.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function importDataFile(file) {
  if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const parsed = JSON.parse(reader.result);
      if (!Array.isArray(parsed)) throw new Error("Invalid file");
      if (!confirm("Replace current data with imported data?")) return;
      data = parsed.map(item => ({
        name: String(item.name||'').trim(),
        score: clamp(Number(item.score)||0),
        status: item.status || "ACTIVE",
        focusedAt: item.focusedAt || null,
        lastUpdate: item.lastUpdate || now()
      })).filter(p=>p.name);
      save();
      render();
      alert("Import complete.");
    } catch(e) {
      alert("Import failed: " + e.message);
    }
  };
  reader.readAsText(file);
}

/* --- add small export/import UI near top (if not present) --- */
(function addExportImportUI(){
  const ctrl = document.createElement('div');
  ctrl.style.margin = '10px 0';
  ctrl.innerHTML = `
    <button id="exportBtn">Export JSON</button>
    <input id="importFile" type="file" accept=".json" style="display:none" />
    <button id="importBtn">Import JSON</button>
  `;
  const root = document.body;
  root.insertBefore(ctrl, document.getElementById('list'));
  document.getElementById('exportBtn').onclick = exportData;
  document.getElementById('importBtn').onclick = ()=> document.getElementById('importFile').click();
  document.getElementById('importFile').onchange = e => importDataFile(e.target.files[0]);
})();
